{% extends 'base.html.twig' %}

{% block title %}Assistant Voyage
{% endblock %}

{% block body %}
	<div class="container my-4">
		<h1 class="mb-4">Assistant de Recherche de Voyages</h1>


		<form method="get" action="{{ path('assistant_voyage') }}" id="filter-form">
			<div class="card mb-4" id="filters-carousel-container">
				<div class="card-body">
					<div class="carousel-container">

						<div class="carousel-indicators mb-3">
							<span class="filter-step active" data-step="1">Durée</span>
							<span class="filter-step" data-step="2">Destination</span>
							<span class="filter-step" data-step="3">Budget</span>
							<span class="filter-step" data-step="4">Formules</span>
							<span class="filter-step" data-step="5">Note</span>
						</div>


						<div class="carousel-items">

							<div class="carousel-item active" data-step="1">
								<h4>Durée maximale du voyage</h4>
								<div class="mb-3">
									<label for="maxDuree" class="form-label">Durée max (jours)</label>
									<input type="range" class="form-range" id="maxDuree" name="maxDuree" min="0" max="90" value="{{ filters.maxDuree }}">
									<span id="maxDureeLabel">{{ filters.maxDuree }}
										jours</span>
									{% if suggestions.suggestionDuree %}
										<div class="alert alert-info mt-2">
											Suggestion basée sur vos précédents voyages : environ
											{{ suggestions.suggestionDuree|number_format(0) }}
											jours.
											<button type="button" class="btn btn-sm btn-primary ms-2" onclick="document.getElementById('maxDuree').value='{{ suggestions.suggestionDuree|number_format(0) }}'; document.getElementById('maxDureeLabel').innerText='{{ suggestions.suggestionDuree|number_format(0) }} jours';">
												Prediction
											</button>
										</div>
									{% endif %}
								</div>
								<div class="carousel-navigation mt-4">
									<button type="button" class="btn btn-primary carousel-apply" data-step="1">Appliquer</button>
									<button type="button" class="btn btn-primary carousel-skip" data-step="1">Passer</button>
								</div>
							</div>


							<div class="carousel-item" data-step="2">
								<h4>Pays de destination</h4>
								<div class="mb-3">
									<label for="selectedPays" class="form-label">Pays de Destination</label>
									<select class="form-select" id="selectedPays" name="selectedPays">
										<option value="">-- Choisir un pays --</option>
										{% for pays in allCountries %}
											<option value="{{ pays }}" {{ pays == filters.selectedPays ? 'selected' : '' }}>{{ pays }}</option>
										{% endfor %}
									</select>
									{% if suggestions.suggestionPays %}
										<div class="alert alert-info mt-2">
											Destination la plus fréquente :
											{{ suggestions.suggestionPays }}.
											<button type="button" class="btn btn-sm btn-primary ms-2" onclick="document.getElementById('selectedPays').value='{{ suggestions.suggestionPays }}';">
												Prediction
											</button>
										</div>
									{% endif %}

									<div class="mt-3 d-flex">
										<input type="text" class="form-control me-2" id="aiDescription" name="aiDescription" placeholder="Donnez une description" value="{{ filters.aiDescription }}">
										<button type="button" class="btn btn-secondary me-2" id="tirflyAiBtn">Consulter Tirfly AI</button>
										<button type="button" class="btn btn-secondary" id="geminiBtn">Consulter Gemini</button>
									</div>
								</div>
								<div class="carousel-navigation mt-4">
									<button type="button" class="btn btn-primary carousel-apply" data-step="2">Appliquer</button>
									<button type="button" class="btn btn-primary carousel-skip" data-step="2">Passer</button>
								</div>
							</div>


							<div class="carousel-item" data-step="3">
								<h4>Budget maximal</h4>
								<div class="mb-3">
									<label for="maxBudget" class="form-label">Budget maximal</label>
									<input type="range" class="form-range" id="maxBudget" name="maxBudget" min="0" max="10000" step="100" value="{{ filters.maxBudget is defined ? filters.maxBudget : 1000 }}">
									<span id="maxBudgetLabel">{{ filters.maxBudget is defined ? filters.maxBudget : 1000 }}
										DT</span>
									{% if suggestions.suggestionBudget %}
										<div class="alert alert-info mt-2">
											Budget moyen précédent :
											{{ suggestions.suggestionBudget|number_format(2) }}
											DT.
											<button type="button" class="btn btn-sm btn-primary ms-2" onclick="document.getElementById('maxBudget').value='{{ suggestions.suggestionBudget|number_format(0) }}'; document.getElementById('maxBudgetLabel').innerText='{{ suggestions.suggestionBudget|number_format(2) }} DT';">
												Prediction
											</button>
										</div>
									{% endif %}
								</div>
								<div class="carousel-navigation mt-4">
									<button type="button" class="btn btn-primary carousel-apply" data-step="3">Appliquer</button>
									<button type="button" class="btn btn-primary carousel-skip" data-step="3">Passer</button>
								</div>
							</div>


							<div class="carousel-item" data-step="4">
								<h4>Formules de voyage</h4>
								<div class="mb-3">
									<label class="form-label">Formule(s)</label>
									<div class="mb-2">
										{% for formule in allFormules %}
											<div class="form-check form-check-inline">
												<input class="form-check-input" type="checkbox" name="formules[]" value="{{ formule }}" id="formule_{{ formule }}" {% if filters.formules is defined and formule in filters.formules %} checked {% endif %}>
												<label class="form-check-label" for="formule_{{ formule }}">{{ formule }}</label>
											</div>
										{% endfor %}
									</div>
									{% if suggestions.suggestionFormule %}
										<div class="alert alert-info mt-2">
											Formule la plus fréquente :
											{{ suggestions.suggestionFormule }}.
											<button type="button" class="btn btn-sm btn-primary ms-2" onclick="document.querySelector('input[value=\'{{ suggestions.suggestionFormule }}\']').checked = true;">
												Prediction
											</button>
										</div>
									{% endif %}
								</div>
								<div class="carousel-navigation mt-4">
									<button type="button" class="btn btn-primary carousel-apply" data-step="4">Appliquer</button>
									<button type="button" class="btn btn-primary carousel-skip" data-step="4">Passer</button>
								</div>
							</div>


							<div class="carousel-item" data-step="5">
								<h4>Note minimale</h4>
								<div class="mb-3">
									<label for="minNote" class="form-label">Note minimale</label>
									<input type="range" class="form-range" id="minNote" name="minNote" min="0" max="5" step="0.5" value="{{ filters.minNote }}">
									<span id="minNoteLabel">{{ filters.minNote }}
										⭐</span>
									{% if suggestions.suggestionNote %}
										<div class="alert alert-info mt-2">
											Note moyenne :
											{{ suggestions.suggestionNote|number_format(1) }}
											⭐.
											<button type="button" class="btn btn-sm btn-primary ms-2" onclick="document.getElementById('minNote').value='{{ suggestions.suggestionNote|number_format(1) }}'; document.getElementById('minNoteLabel').innerText='{{ suggestions.suggestionNote|number_format(1) }} ⭐';">
												Prediction
											</button>
										</div>
									{% endif %}
								</div>
								<div class="carousel-navigation mt-4">
									<button type="button" class="btn btn-primary" id="apply-all-filters">Appliquer les filtres</button>
									<button type="button" class="btn btn-primary" id="reset-filters">Réinitialiser</button>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</form>


		<div class="row" id="voyages-results" style="display: none;">
			{% if voyages is empty %}
				<div class="col-12">
					<div class="alert alert-danger text-center">
						Aucun voyage disponible.
					</div>
				</div>
			{% else %}
				<div class="d-flex justify-content-between mb-3">
					<h3>Résultats ({{ voyages|length }}
						voyages)</h3>
					<button class="btn btn-outline-primary" id="show-filters">Modifier les filtres</button>
				</div>
				<div class="voyage-grid">
					{% for voyage in voyages %}
						<a href="{{ path('details_voyage', {'id': voyage.id}) }}" class="voyage-card-link">
							<div class="voyage-card">
								{% if voyage.image %}
									<img src="{{ voyage.getImageUrl() }}" alt="Image du voyage" class="card-image">
								{% else %}
									<img src="{{ asset('images/default.jpg') }}" height="100px" alt="Image par défaut" class="card-image"/>
								{% endif %}

								<div class="card-title">{{ voyage.nom }}</div>

								<div class="card-details">
									{{ voyage.dateDepart | date('d-M-Y') }}<br>
									{{ voyage.dateDepart.diff(voyage.dateArrive).days }}
									jours<br>
									{{ voyage.destination.ville }},
									{{ voyage.destination.pays }}
								</div>

								<div class="card-price">{{ voyage.prix }}
									DT</div>

								<button class="card-reserve-button">Détails</button>
							</div>
						</a>
					{% endfor %}
				</div>
			{% endif %}
		</div>
	</div>

	<style>
		.carousel-container {
			position: relative;
			overflow: hidden;
		}

		.carousel-indicators {
			display: flex;
			justify-content: space-between;
			margin-bottom: 20px;
			border-bottom: 1px solid #eee;
			padding-bottom: 10px;
		}

		.filter-step {
			position: relative;
			padding: 5px 0;
			color: #6c757d;
			cursor: default;
			font-weight: 500;
			font-size: 0.9rem;
		}

		.filter-step.active {
			color: #0d6efd;
			font-weight: bold;
		}

		.filter-step.completed {
			color: #198754;
		}

		.filter-step.active:after {
			content: '';
			position: absolute;
			bottom: -11px;
			left: 0;
			width: 100%;
			height: 3px;
			background-color: #0d6efd;
		}

		.carousel-items {
			position: relative;
		}

		.carousel-item {
			display: none;
			transition: opacity 0.3s ease;
		}

		.carousel-item.active {
			display: block;
		}

		.carousel-navigation {
			display: flex;
			justify-content: space-between;
		}
	</style>


	 <script>
	    document.addEventListener('DOMContentLoaded', function() {
	        
	        const maxDureeInput = document.getElementById('maxDuree');
	        const maxDureeLabel = document.getElementById('maxDureeLabel');
	        maxDureeInput.addEventListener('input', function () {
	            maxDureeLabel.innerText = this.value + " jours";
	        });
	
	        const maxBudgetInput = document.getElementById('maxBudget');
	        const maxBudgetLabel = document.getElementById('maxBudgetLabel');
	        maxBudgetInput.addEventListener('input', function () {
	            maxBudgetLabel.innerText = this.value + " DT";
	        });
	
	        const minNoteInput = document.getElementById('minNote');
	        const minNoteLabel = document.getElementById('minNoteLabel');
	        minNoteInput.addEventListener('input', function () {
	            minNoteLabel.innerText = this.value + " ⭐";
	        });
	
	        
	        const carouselApplyButtons = document.querySelectorAll('.carousel-apply');
	        const carouselSkipButtons = document.querySelectorAll('.carousel-skip');
	        const carouselItems = document.querySelectorAll('.carousel-item');
	        const filterSteps = document.querySelectorAll('.filter-step');
	        const applyAllFiltersBtn = document.getElementById('apply-all-filters');
	        const resetFiltersBtn = document.getElementById('reset-filters');
	        const filterForm = document.getElementById('filter-form');
	        const voyagesResults = document.getElementById('voyages-results');
	        const filtersContainer = document.getElementById('filters-carousel-container');
	        const showFiltersBtn = document.getElementById('show-filters');
	
	        function showStep(step) {
	            
	            carouselItems.forEach(item => {
	                item.classList.remove('active');
	            });
	            
	            
	            const currentItem = document.querySelector(`.carousel-item[data-step="${step}"]`);
	            if (currentItem) {
	                currentItem.classList.add('active');
	            }
	            
	            
	            filterSteps.forEach(stepIndicator => {
	                stepIndicator.classList.remove('active');
	                if (parseInt(stepIndicator.dataset.step) === step) {
	                    stepIndicator.classList.add('active');
	                } else if (parseInt(stepIndicator.dataset.step) < step) {
	                    stepIndicator.classList.add('completed');
	                }
	            });
	        }
	
	        
	        carouselApplyButtons.forEach(button => {
	            button.addEventListener('click', function() {
	                const currentStep = parseInt(this.dataset.step);
	                const nextStep = currentStep + 1;
	                
	                
	                const currentStepIndicator = document.querySelector(`.filter-step[data-step="${currentStep}"]`);
	                currentStepIndicator.classList.add('completed');
	                
	                
	                if (nextStep <= 5) {
	                    showStep(nextStep);
	                }
	            });
	        });
	
	        
	        carouselSkipButtons.forEach(button => {
	            button.addEventListener('click', function() {
	                const currentStep = parseInt(this.dataset.step);
	                const nextStep = currentStep + 1;
	                
	                
	                if (nextStep <= 5) {
	                    showStep(nextStep);
	                }
	            });
	        });
	
	        
	        applyAllFiltersBtn.addEventListener('click', function() {
	            filterForm.submit();
	        });
	
	        
	        resetFiltersBtn.addEventListener('click', function() {
	            window.location.href = "{{ path('assistant_voyage') }}";
	        });
	
	        
	        showFiltersBtn.addEventListener('click', function() {
	            voyagesResults.style.display = 'none';
	            filtersContainer.style.display = 'block';
	            showStep(1); 
	        });
	
	        
	        const urlParams = new URLSearchParams(window.location.search);
	        if (urlParams.toString()) {
	            filtersContainer.style.display = 'none';
	            voyagesResults.style.display = 'block';
	        }
	
	        
	        const tirflyAiBtn = document.getElementById('tirflyAiBtn');
	        const geminiBtn = document.getElementById('geminiBtn');
	        const aiDescriptionInput = document.getElementById('aiDescription');
	
	        if (tirflyAiBtn) {
	            tirflyAiBtn.addEventListener('click', function() {
	                const description = aiDescriptionInput.value;
	                if (description) {
	                    
	                    if (typeof consultTirflyAI === 'function') {
	                        consultTirflyAI(description);
	                    }
	                } else {
	                    alert('Veuillez entrer une description pour consulter Tirfly AI');
	                }
	            });
	        }
	
	        if (geminiBtn) {
	            geminiBtn.addEventListener('click', function() {
	                const description = aiDescriptionInput.value;
	                if (description) {
	                    
	                    if (typeof consultGemini === 'function') {
	                        consultGemini(description);
	                    }
	                } else {
	                    alert('Veuillez entrer une description pour consulter Gemini');
	                }
	            });
	        }
	    });
	</script>

 <script src="{{ asset('js/tirflyAi.js') }}"></script>
	 <script src="{{ asset('js/gemini.js') }}"></script>
{% endblock %}
